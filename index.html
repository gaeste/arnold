<!DOCTYPE html>

<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Closet AI</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        color: white;
        padding: 20px;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
    }

    h1 {
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .subtitle {
        text-align: center;
        color: #8b8fa3;
        font-size: 0.9rem;
        margin-bottom: 24px;
    }

    .card {
        background: #252a41;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .preview-container {
        position: relative;
        width: 100%;
        aspect-ratio: 3/4;
        background: #1a1a2e;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
    }

    .preview-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .placeholder {
        text-align: center;
        color: #8b8fa3;
    }

    .placeholder-icon {
        font-size: 3rem;
        margin-bottom: 12px;
    }

    .btn {
        width: 100%;
        padding: 16px 24px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.1s, opacity 0.2s;
    }

    .btn:active {
        transform: scale(0.98);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: #3a4066;
        color: white;
        margin-top: 12px;
    }

    .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        margin-top: 12px;
    }

    .hidden {
        display: none !important;
    }

    #cameraInput, #galleryInput {
        display: none;
    }

    .api-section {
        margin-bottom: 16px;
    }

    .api-section label {
        display: block;
        font-size: 0.85rem;
        color: #8b8fa3;
        margin-bottom: 8px;
    }

    .api-input {
        width: 100%;
        padding: 12px 16px;
        font-size: 1rem;
        border: 2px solid #3a4066;
        border-radius: 10px;
        background: #1a1a2e;
        color: white;
        outline: none;
        transition: border-color 0.2s;
    }

    .api-input:focus {
        border-color: #667eea;
    }

    .api-input::placeholder {
        color: #555;
    }

    .result-card {
        background: #252a41;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .result-card h3 {
        font-size: 1rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .result-content {
        font-size: 0.95rem;
        line-height: 1.7;
        color: #e0e0e0;
    }

    .result-content h1, .result-content h2, .result-content h3 {
        color: white;
        margin: 16px 0 8px 0;
    }

    .result-content h1 { font-size: 1.3rem; }
    .result-content h2 { font-size: 1.15rem; }
    .result-content h3 { font-size: 1.05rem; }

    .result-content p {
        margin-bottom: 12px;
    }

    .result-content ul, .result-content ol {
        margin: 12px 0;
        padding-left: 24px;
    }

    .result-content li {
        margin-bottom: 6px;
    }

    .result-content strong {
        color: white;
    }

    .result-content a {
        text-decoration: none;
        font-size: 1.1em;
        margin-left: 4px;
        opacity: 0.8;
        transition: opacity 0.2s, transform 0.2s;
        display: inline-block;
    }

    .result-content a:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px;
        color: #8b8fa3;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #3a4066;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error {
        background: #3d2a2a;
        border: 1px solid #e74c3c;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        color: #ff8a80;
        font-size: 0.9rem;
    }

    .info-text {
        font-size: 0.8rem;
        color: #8b8fa3;
        margin-top: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-dot.ready {
        background: #38ef7d;
    }

    .status-dot.waiting {
        background: #f39c12;
    }

    .config-toggle {
        background: transparent;
        border: 1px solid #3a4066;
        color: #8b8fa3;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        font-size: 0.9rem;
        transition: background 0.2s, border-color 0.2s;
        margin-bottom: 20px;
    }

    .config-toggle:hover {
        background: #252a41;
        border-color: #667eea;
    }

    .config-toggle .arrow {
        transition: transform 0.2s;
    }

    .config-toggle.open .arrow {
        transform: rotate(180deg);
    }

    .config-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .config-content.open {
        max-height: 200px;
    }
</style>
</head>
<body>
    <div class="container">
        <h1>üëî Closet AI</h1>
        <p class="subtitle">Ta en bild och f√• personliga stilf√∂rslag</p>

    <!-- Konfig-knapp -->
    <button class="config-toggle" id="configToggle">
        <span><span class="status-dot waiting" id="statusDot"></span> Inst√§llningar</span>
        <span class="arrow">‚ñº</span>
    </button>

    <!-- API-nyckel (dold som standard) -->
    <div class="config-content" id="configContent">
        <div class="card">
            <div class="api-section">
                <label for="apiKey">Google Gemini API-nyckel</label>
                <input type="password"
                       id="apiKey"
                       class="api-input"
                       placeholder="AIzaSy..."
                       autocomplete="off">
                <p class="info-text">H√§mta gratis nyckel p√• <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea;">Google AI Studio</a></p>
            </div>
        </div>
    </div>

    <!-- Kamera -->
    <div class="card">
        <div class="preview-container" id="previewContainer">
            <div class="placeholder" id="placeholder">
                <div class="placeholder-icon">üì∑</div>
                <p>Ta en bild f√∂r analys</p>
            </div>
            <img id="preview" class="hidden" alt="F√∂rhandsvisning">
        </div>

        <input type="file"
               id="cameraInput"
               accept="image/*"
               capture="environment">

        <input type="file"
               id="galleryInput"
               accept="image/*">

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" id="takePhotoBtn" style="flex: 1;">
                üì∏ Kamera
            </button>
            <button class="btn btn-primary" id="galleryBtn" style="flex: 1;">
                üñºÔ∏è Bildbibliotek
            </button>
        </div>

        <div class="hidden" id="analyzeButtons" style="display: none; flex-direction: column; gap: 10px; margin-top: 12px;">
            <button class="btn btn-success" id="quickAnalyzeBtn">
                ‚ö° Snabb analys
            </button>
            <button class="btn btn-secondary" id="fullAnalyzeBtn">
                üìã Fullst√§ndig analys
            </button>
        </div>

        <button class="btn btn-secondary hidden" id="retakeBtn">
            üîÑ Ta en ny bild
        </button>
    </div>

    <!-- Resultat -->
    <div id="resultSection" class="hidden">
        <div class="result-card">
            <h3>‚ú® Dina stilf√∂rslag</h3>
            <div class="result-content" id="resultContent"></div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingSection" class="hidden">
        <div class="loading">
            <div class="spinner"></div>
            <p>Analyserar din stil...</p>
        </div>
    </div>

    <!-- Error -->
    <div id="errorSection" class="hidden">
        <div class="error" id="errorMessage"></div>
    </div>
</div>

<script>
    const cameraInput = document.getElementById('cameraInput');
    const galleryInput = document.getElementById('galleryInput');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const galleryBtn = document.getElementById('galleryBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const analyzeButtons = document.getElementById('analyzeButtons');
    const quickAnalyzeBtn = document.getElementById('quickAnalyzeBtn');
    const fullAnalyzeBtn = document.getElementById('fullAnalyzeBtn');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const apiKeyInput = document.getElementById('apiKey');
    const statusDot = document.getElementById('statusDot');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const loadingSection = document.getElementById('loadingSection');
    const errorSection = document.getElementById('errorSection');
    const errorMessage = document.getElementById('errorMessage');
    const configToggle = document.getElementById('configToggle');
    const configContent = document.getElementById('configContent');

    let currentImageBase64 = null;

    // Konfig-toggle
    configToggle.addEventListener('click', () => {
        configToggle.classList.toggle('open');
        configContent.classList.toggle('open');
    });

    // Ladda sparad API-nyckel
    const savedKey = localStorage.getItem('gemini_api_key');
    if (savedKey) {
        apiKeyInput.value = savedKey;
        statusDot.classList.remove('waiting');
        statusDot.classList.add('ready');
    } else {
        // √ñppna konfig om ingen nyckel finns
        configToggle.classList.add('open');
        configContent.classList.add('open');
    }

    // Spara API-nyckel n√§r den √§ndras
    apiKeyInput.addEventListener('input', () => {
        const key = apiKeyInput.value.trim();
        if (key) {
            localStorage.setItem('gemini_api_key', key);
            statusDot.classList.remove('waiting');
            statusDot.classList.add('ready');
        } else {
            localStorage.removeItem('gemini_api_key');
            statusDot.classList.remove('ready');
            statusDot.classList.add('waiting');
        }
    });

    // Kamera-knappar
    takePhotoBtn.addEventListener('click', () => cameraInput.click());
    galleryBtn.addEventListener('click', () => galleryInput.click());
    retakeBtn.addEventListener('click', () => cameraInput.click());

    // Hantera bild (gemensam funktion)
    function handleImageSelect(event) {
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                const base64Full = e.target.result;
                currentImageBase64 = base64Full.split(',')[1]; // Ta bort data:image/...;base64,

                preview.src = base64Full;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                retakeBtn.classList.remove('hidden');
                analyzeButtons.classList.remove('hidden');
                analyzeButtons.style.display = 'flex';

                // G√∂m tidigare resultat
                resultSection.classList.add('hidden');
                errorSection.classList.add('hidden');
            };

            reader.readAsDataURL(file);
        }
    }

    cameraInput.addEventListener('change', handleImageSelect);
    galleryInput.addEventListener('change', handleImageSelect);

    // Prompts
    const quickPrompt = `Du √§r en stilr√•dgivare. Ge 3 korta, konkreta tips p√• plagg eller accessoarer som skulle passa personen p√• bilden.

F√∂r varje f√∂rslag, l√§gg till en liten shoppingl√§nk med en kundkorg-emoji direkt efter plagget:
**Plaggnamn** [üõí](https://www.zalando.se/katalog/?q=s√∂kord)

Exempel: **M√∂rkbl√• slim jeans** [üõí](https://www.zalando.se/katalog/?q=m√∂rkbl√•+slim+jeans+herr)

Max 3 f√∂rslag. Svara p√• svenska.`;

    const fullPrompt = `Du √§r en personlig stilr√•dgivare. Analysera personen p√• bilden och ge konkreta modef√∂rslag.

Beskriv kort:
1. Vad personen har p√• sig just nu
2. Vilken stil/estetik det lutar √•t
3. 3-5 konkreta f√∂rslag p√• plagg eller accessoarer som skulle komplettera stilen
4. F√§rger som skulle passa personen

VIKTIGT: F√∂r varje konkret plaggf√∂rslag, l√§gg till en liten shoppingl√§nk med kundkorg-emoji:
**Plaggnamn** [üõí](https://www.zalando.se/katalog/?q=s√∂kord)

Exempel: **Beige trenchcoat** [üõí](https://www.zalando.se/katalog/?q=beige+trenchcoat+dam)

Var positiv och personlig. Svara p√• svenska.`;

    // Analysera bild
    async function analyzeImage(prompt) {
        const apiKey = apiKeyInput.value.trim();

        if (!apiKey) {
            showError('Ange din Gemini API-nyckel f√∂rst');
            return;
        }

        if (!currentImageBase64) {
            showError('Ta en bild f√∂rst');
            return;
        }

        // Visa loading
        loadingSection.classList.remove('hidden');
        resultSection.classList.add('hidden');
        errorSection.classList.add('hidden');
        quickAnalyzeBtn.disabled = true;
        fullAnalyzeBtn.disabled = true;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            {
                                inline_data: {
                                    mime_type: 'image/jpeg',
                                    data: currentImageBase64
                                }
                            },
                            {
                                text: prompt
                            }
                        ]
                    }]
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || 'N√•got gick fel med API-anropet');
            }

            // Visa resultat
            const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!resultText) {
                throw new Error('Kunde inte tolka svaret fr√•n Gemini');
            }
            resultContent.innerHTML = parseMarkdown(resultText);
            resultSection.classList.remove('hidden');

        } catch (error) {
            showError(error.message);
        } finally {
            loadingSection.classList.add('hidden');
            quickAnalyzeBtn.disabled = false;
            fullAnalyzeBtn.disabled = false;
        }
    }

    quickAnalyzeBtn.addEventListener('click', () => analyzeImage(quickPrompt));
    fullAnalyzeBtn.addEventListener('click', () => analyzeImage(fullPrompt));

    function showError(message) {
        errorMessage.textContent = message;
        errorSection.classList.remove('hidden');
    }

    function parseMarkdown(text) {
        return text
            // Links [text](url)
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
            // Headers
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            // Bold
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            // Italic
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            // Unordered lists
            .replace(/^\* (.+)$/gm, '<li>$1</li>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            // Ordered lists
            .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
            // Wrap consecutive <li> in <ul>
            .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
            // Paragraphs (double newlines)
            .replace(/\n\n/g, '</p><p>')
            // Single newlines within paragraphs
            .replace(/\n/g, '<br>')
            // Wrap in paragraph
            .replace(/^(.+)$/s, '<p>$1</p>')
            // Clean up empty paragraphs
            .replace(/<p><\/p>/g, '')
            .replace(/<p>(<h[123]>)/g, '$1')
            .replace(/(<\/h[123]>)<\/p>/g, '$1')
            .replace(/<p>(<ul>)/g, '$1')
            .replace(/(<\/ul>)<\/p>/g, '$1');
    }
</script>
</body>
</html>
